﻿@using HumanResourcesManager.BLL.DTOs.Employee
@using HumanResourcesManager.Helpers
@model EmployeeAttendanceViewDTO

@{
	Layout = "~/Views/Employee/_EmployeeLayout.cshtml";
}

<!-- Main Content -->
<main class="flex-1 overflow-y-auto bg-slate-50/50">
	@await Html.PartialAsync("_EmployeeHeader")

	<div class="p-5 lg:p-8">
		@await Html.PartialAsync("_EmployeeStats")

		<!-- Tabs Content -->
		<div class="bg-white rounded-2xl shadow-sm border border-slate-200/60 overflow-hidden">
			<!-- Header -->
			<div class="px-6 py-6 border-b border-slate-200 bg-gradient-to-r from-slate-50 to-white">
				<div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4">

					<!-- Title + Subtitle -->
					<div>
						<h2 class="text-xl font-bold text-slate-800 tracking-tight">
							Lịch Sử Chấm Công
						</h2>
						<p class="text-sm text-slate-500 mt-1">
							Xem và lọc lịch sử chấm công của bạn
						</p>
					</div>

					<!-- Back Button -->

					<a asp-action="Index"
					   class="group inline-flex items-center gap-2
          px-5 py-2.5 rounded-xl text-sm font-semibold
          border border-indigo-200 bg-indigo-50
          text-indigo-700
          hover:bg-indigo-600 hover:text-white
          hover:border-indigo-600
          transition-all duration-200 shadow-sm hover:shadow-md">

						<svg xmlns="http://www.w3.org/2000/svg"
							 class="w-4 h-4 transition-transform duration-200 group-hover:-translate-x-1"
							 fill="none"
							 viewBox="0 0 24 24"
							 stroke="currentColor"
							 stroke-width="2">
							<path stroke-linecap="round"
								  stroke-linejoin="round"
								  d="M15 19l-7-7 7-7" />
						</svg>
						Quay lại
					</a>
				</div>
			</div>

			<div class="p-6">
				<div class="max-w-6xl mx-auto">


					<!-- Filter -->
				</div>
				<form method="get" class="bg-slate-50 border border-slate-200 rounded-2xl p-6 shadow-sm mb-8" action="/HumanResourcesManager/employee/attendance/history">

					<div class="grid grid-cols-1 md:grid-cols-5 gap-6 items-end">

						<!-- Page Size -->
						<div>
							<label class="block text-xs text-slate-500 mb-1">Số dòng / trang</label>
							<select name="pageSize"
									class="border rounded-lg px-3 py-2 text-sm">
								<option value="3" selected="@(Model.PageSize == 3)">3</option>
								<option value="5" selected="@(Model.PageSize == 5)">5</option>
								<option value="10" selected="@(Model.PageSize == 10)">10</option>
								<option value="20" selected="@(Model.PageSize == 20)">20</option>
							</select>
						</div>

						<!-- Month -->
						<select name="month"
								class="text-sm border border-slate-200 rounded-lg px-3 py-2 bg-white focus:outline-none focus:ring-2 focus:ring-indigo-500">
							<option value="">Tháng</option>
							@for (int m = 1; m <= 12; m++)
							{
								<option value="@m"
										selected="@(Model.SelectedMonth == m)">
									Tháng @m
								</option>
							}
						</select>

						<!-- Year -->
						<select name="year"
								class="text-sm border border-slate-200 rounded-lg px-3 py-2 bg-white focus:outline-none focus:ring-2 focus:ring-indigo-500">
							<option value="">Năm</option>
							@for (int y = DateTime.Now.Year - 5; y <= DateTime.Now.Year; y++)
							{
								<option value="@y"
										selected="@(Model.SelectedYear == y)">
									@y
								</option>
							}
						</select>

						<!-- Status -->
						<select name="status"
								class="text-sm border border-slate-200 rounded-lg px-3 py-2">
							<option value="">Tất cả trạng thái</option>

							@foreach (var s in Enum.GetValues(typeof(HumanResourcesManager.DAL.Enum.AttendanceStatus)))
							{
								var enumValue = (HumanResourcesManager.DAL.Enum.AttendanceStatus)s;

								<option value="@enumValue"
										selected="@(Model.SelectedStatus == enumValue)">
									@enumValue.ToDisplayName()
								</option>
							}
						</select>

						<!-- Buttons -->
						<div class="flex gap-3">
							<button type="submit"
									class="flex-1 bg-indigo-600 text-white py-2.5 rounded-xl text-sm font-medium hover:bg-indigo-700 transition shadow">
								Lọc
							</button>

							<a class="flex items-center justify-center w-11 h-11 rounded-xl border border-slate-300 bg-white hover:bg-slate-100 transition shadow-sm" href="/HumanResourcesManager/employee/attendance/history?page=1">
								↺
							</a>
						</div>

					</div>
				</form>
				<!-- Bảng -->
				<div class="overflow-x-auto rounded-xl border border-slate-200/80">
					<table class="min-w-full text-sm text-slate-700 border-collapse">
						<thead>
							<tr class="bg-slate-50 border-b border-slate-200 text-slate-600">
								<th class="py-4 px-4 text-center text-xs font-semibold uppercase tracking-wider">STT</th>
								<th class="py-4 px-4 text-center text-xs font-semibold uppercase tracking-wider">Ngày</th>
								<th class="py-4 px-4 text-center text-xs font-semibold uppercase tracking-wider">Giờ vào</th>
								<th class="py-4 px-4 text-center text-xs font-semibold uppercase tracking-wider">Ảnh</th>
								<th class="py-4 px-4 text-center text-xs font-semibold uppercase tracking-wider">Giờ ra</th>
								<th class="py-4 px-4 text-center text-xs font-semibold uppercase tracking-wider">Ảnh</th>
								<th class="py-4 px-4 text-center text-xs font-semibold uppercase tracking-wider">Thiếu (phút)</th>
								<th class="py-4 px-4 text-center text-xs font-semibold uppercase tracking-wider">Trạng thái</th>
							</tr>
						</thead>


						<tbody class="divide-y divide-slate-100">
							@{
								int pageSize = Model.PageSize;
								int startIndex = (Model.CurrentPage - 1) * pageSize;
								int index = 0;
							}

							@if (Model.Records != null && Model.Records.Any())
							{
								foreach (var item in Model.Records)
								{
									index++;
									<tr class="hover:bg-slate-50 transition-colors duration-150">

										<!-- STT -->
										<td class="py-3 px-4 text-center text-slate-500 font-medium">
											@(startIndex + index)
										</td>

										<!-- Work Date -->
										<td class="py-3 px-4 text-center font-medium text-slate-800">
											@item.WorkDate.ToString("dd/MM/yyyy")
										</td>

										<!-- Check In -->
										<td class="py-3 px-4 text-center">
											@(item.CheckIn?.ToString(@"hh\:mm") ?? "---")
										</td>

										<!-- Check In Image -->
										<td class="py-3 px-4 text-center">
											@if (!string.IsNullOrWhiteSpace(item.CheckInImagePath))
											{
												<button type="button"
														onclick="openCheckInModal('@Url.Content(item.CheckInImagePath)')"
														class="inline-flex items-center justify-center text-indigo-600 hover:text-indigo-800 transition">
													👁
												</button>
											}
											else
											{
												<span class="text-slate-300">—</span>
											}
										</td>

										<!-- Check Out -->
										<td class="py-3 px-4 text-center">
											@(item.CheckOut?.ToString(@"hh\:mm") ?? "---")
										</td>

										<!-- Check Out Image -->
										<td class="py-3 px-4 text-center">
											@if (!string.IsNullOrWhiteSpace(item.CheckOutImagePath))
											{
												<button type="button"
														onclick="openCheckOutModal('@Url.Content(item.CheckOutImagePath)')"
														class="inline-flex items-center justify-center text-indigo-600 hover:text-indigo-800 transition">
													👁
												</button>
											}
											else
											{
												<span class="text-slate-300">—</span>
											}
										</td>

										<!-- Missing Minutes -->
										<td class="py-3 px-4 text-center">
											@if (item.MissingMinutes > 0)
											{
												<span class="px-2 py-1 rounded-md text-xs bg-orange-100 text-orange-700 font-medium">
													@item.MissingMinutes
												</span>
											}
											else
											{
												<span class="text-slate-400">0</span>
											}
								</td>

								<!-- Status -->
								<td class="py-3 px-4 text-center">
									<span class="px-3 py-1 text-xs font-medium rounded-full
                @(item.Status switch
			   {
				   "Đủ công" => "bg-green-100 text-green-700",
				   "Thiếu công" => "bg-orange-100 text-orange-700",
				   "Đang làm việc" => "bg-indigo-100 text-indigo-700",
				   "Nghỉ có phép" => "bg-blue-100 text-blue-700",
				   "Thiếu Check-in" => "bg-yellow-100 text-yellow-700",
				   "Thiếu Check-out" => "bg-yellow-100 text-yellow-700",
				   "Nghỉ không phép" => "bg-red-100 text-red-700",
				   _ => "bg-gray-100 text-gray-600"
			   })">
										@item.Status
									</span>
								</td>

							</tr>
														}
							}
							else
							{
								<tr>
									<td colspan="8" class="py-12 text-center text-slate-500">
										<div class="flex flex-col items-center space-y-2">
											<span class="text-lg font-medium">Không có dữ liệu chấm công</span>
											<span class="text-sm text-slate-400">
												Hãy thử thay đổi bộ lọc hoặc chọn tháng khác
											</span>
										</div>
									</td>
								</tr>
							}
						</tbody>
					</table>
				</div>

				<!-- Phân Trang -->
				@if (Model.Records != null && Model.Records.Any() && Model.TotalPages > 1)
				{
					int currentPage = Model.CurrentPage;
					int totalPages = Model.TotalPages;
					int pageWindow = 1;

					int startPage = Math.Max(1, currentPage - pageWindow);
					int endPage = Math.Min(totalPages, currentPage + pageWindow);

					<div class="flex justify-center mt-6 space-x-1 items-center">

						<!-- Prev -->
						<a asp-action="History"
						   asp-route-page="@(currentPage - 1)"
						   asp-route-pageSize="@Model.PageSize"
						   asp-route-month="@Model.SelectedMonth"
						   asp-route-year="@Model.SelectedYear"
						   asp-route-status="@Model.SelectedStatus"
						   class="px-3 py-1 border rounded-lg min-w-[36px] text-center transition
			           @(currentPage > 1
														? "bg-white hover:bg-slate-100"
											  		: "bg-slate-100 text-slate-400 cursor-not-allowed pointer-events-none")">
						&lt;
					</a>

						<!-- Trang đầu -->
					@if (startPage > 1)
						{
							<a asp-action="History"
							   asp-route-page="1"
							   asp-route-pageSize="@Model.PageSize"
							   asp-route-month="@Model.SelectedMonth"
							   asp-route-year="@Model.SelectedYear"
							   asp-route-status="@Model.SelectedStatus"
							   class="px-3 py-1 border rounded-lg bg-white hover:bg-slate-100 min-w-[36px] text-center">
								1
							</a>

							@if (startPage > 2)
							{
								<span class="px-2 text-slate-400">...</span>
							}
						}

						<!-- Các trang quanh current -->
						@for (int i = startPage; i <= endPage; i++)
						{
							<a asp-action="History"
							   asp-route-page="@i"
							   asp-route-pageSize="@Model.PageSize"
							   asp-route-month="@Model.SelectedMonth"
							   asp-route-year="@Model.SelectedYear"
							   asp-route-status="@Model.SelectedStatus"
							   class="px-3 py-1 border rounded-lg min-w-[36px] text-center transition
				               @(i == currentPage
											  		? "bg-indigo-600 text-white"
											  		: "bg-white hover:bg-slate-100")">
						@i
					</a>
										}

						<!-- Trang cuối -->
						@if (endPage < totalPages)
						{
							@if (endPage < totalPages - 1)
							{
								<span class="px-2 text-slate-400">...</span>
							}

							<a asp-action="History"
							   asp-route-page="@totalPages"
							   asp-route-pageSize="@Model.PageSize"
							   asp-route-month="@Model.SelectedMonth"
							   asp-route-year="@Model.SelectedYear"
							   asp-route-status="@Model.SelectedStatus"
							   class="px-3 py-1 border rounded-lg bg-white hover:bg-slate-100 min-w-[36px] text-center">
								@totalPages
							</a>
						}

					<!-- Next -->
					<a asp-action="History"
					   asp-route-page="@(currentPage + 1)"
					   asp-route-pageSize="@Model.PageSize"
					   asp-route-month="@Model.SelectedMonth"
					   asp-route-year="@Model.SelectedYear"
					   asp-route-status="@Model.SelectedStatus"
					   class="px-3 py-1 border rounded-lg min-w-[36px] text-center transition
           @(currentPage < totalPages
						  		? "bg-white hover:bg-slate-100"
						  		: "bg-slate-100 text-slate-400 cursor-not-allowed pointer-events-none")">
						&gt;
					</a>

					</div>
								}
			</div>
		</div>
	</div>
</main>

<!-- Check In Image Modal -->
<div id="checkInImageModal"
	 class="fixed inset-0 bg-black/70 backdrop-blur-sm hidden items-center justify-center z-50">

	<div class="relative bg-white rounded-3xl shadow-2xl max-w-4xl w-full mx-6 overflow-hidden">

		<!-- Header -->
		<div class="flex items-center justify-between px-6 py-4 border-b bg-gradient-to-r from-emerald-50 to-slate-100">
			<div>
				<h2 class="text-xl font-semibold text-slate-800 tracking-tight">
					Ảnh Check-in
				</h2>
				<p class="text-sm text-slate-500 mt-1">
					Ảnh xác nhận thời điểm bắt đầu làm việc
				</p>
			</div>

			<button onclick="closeCheckInModal()"
					class="w-9 h-9 flex items-center justify-center rounded-full
                           bg-white shadow-md text-gray-400
                           hover:text-white hover:bg-red-500 transition">
				✕
			</button>
		</div>

		<!-- Body -->
		<div class="p-8 flex items-center justify-center min-h-[300px]">

			<!-- Image Wrapper Vuông -->
			<div class="w-full max-w-[500px] aspect-square overflow-hidden rounded-2xl bg-slate-100 shadow-sm">
				<img id="checkInPreviewImage"
					 class="w-full h-full object-cover hidden transition duration-300" />
			</div>

			<!-- Fallback UI -->
			<div id="checkInNoImage"
				 class="hidden flex flex-col items-center justify-center py-16 absolute">

				<div class="w-24 h-24 flex items-center justify-center
                    rounded-full bg-slate-100 text-slate-400 text-4xl mb-6 shadow-inner">
					🖼
				</div>

				<h3 class="text-lg font-semibold text-gray-700">
					Không có ảnh Check-in
				</h3>
			</div>

		</div>

	</div>
</div>

<!-- Check Out Image Modal -->
<div id="checkOutImageModal"
	 class="fixed inset-0 bg-black/70 backdrop-blur-sm hidden items-center justify-center z-50">

	<div class="relative bg-white rounded-3xl shadow-2xl max-w-4xl w-full mx-6 overflow-hidden">

		<!-- Header -->
		<div class="flex items-center justify-between px-6 py-4 border-b bg-gradient-to-r from-indigo-50 to-slate-100">
			<div>
				<h2 class="text-xl font-semibold text-slate-800 tracking-tight">
					Ảnh Check-out
				</h2>
				<p class="text-sm text-slate-500 mt-1">
					Ảnh xác nhận thời điểm kết thúc làm việc
				</p>
			</div>

			<button onclick="closeCheckOutModal()"
					class="w-9 h-9 flex items-center justify-center rounded-full
                           bg-white shadow-md text-gray-400
                           hover:text-white hover:bg-red-500 transition">
				✕
			</button>
		</div>

		<!-- Body -->
		<div class="p-8 flex items-center justify-center min-h-[300px]">

			<!-- Image Wrapper Vuông -->
			<div class="w-full max-w-[500px] aspect-square overflow-hidden rounded-2xl bg-slate-100 shadow-sm">
				<img id="checkOutPreviewImage"
					 class="w-full h-full object-cover hidden transition duration-300" />
			</div>

			<!-- Fallback UI -->
			<div id="checkOutNoImage"
				 class="hidden flex flex-col items-center justify-center py-16 absolute">

				<div class="w-24 h-24 flex items-center justify-center
                    rounded-full bg-slate-100 text-slate-400 text-4xl mb-6 shadow-inner">
					🖼
				</div>

				<h3 class="text-lg font-semibold text-gray-700">
					Không có ảnh Check-out
				</h3>
			</div>

		</div>

	</div>
</div>

<!-- Validate Filter -->
<script>
	const monthSelect = document.querySelector("select[name='month']");
	const yearSelect = document.querySelector("select[name='year']");

	const currentDate = new Date();
	const currentYear = currentDate.getFullYear();
	const currentMonth = currentDate.getMonth() + 1;

	function validateFutureDate() {
		const selectedMonth = parseInt(monthSelect.value);
		const selectedYear = parseInt(yearSelect.value);

		if (!selectedMonth || !selectedYear) return;

		// Nếu năm lớn hơn năm hiện tại
		if (selectedYear > currentYear) {
			alert("Không thể chọn năm trong tương lai.");
			yearSelect.value = "";
			monthSelect.value = "";
			return;
		}

		// Nếu cùng năm nhưng tháng lớn hơn tháng hiện tại
		if (selectedYear === currentYear && selectedMonth > currentMonth) {
			alert("Không thể chọn tháng trong tương lai.");
			monthSelect.value = "";
		}
	}

	// Bắt buộc chọn year nếu đã chọn month
	monthSelect.addEventListener("change", function () {
		if (this.value) {
			yearSelect.setAttribute("required", "required");
		} else {
			yearSelect.removeAttribute("required");
		}

		validateFutureDate();
	});

	// Khi đổi year cũng check tương lai
	yearSelect.addEventListener("change", function () {
		validateFutureDate();
	});
</script>

<!-- Modal Attendance Event -->
<script>
	function openCheckInModal(imageUrl) {
		const modal = document.getElementById("checkInImageModal");
		const img = document.getElementById("checkInPreviewImage");
		const fallback = document.getElementById("checkInNoImage");

		modal.classList.remove("hidden");
		modal.classList.add("flex");

		img.classList.add("hidden");
		fallback.classList.add("hidden");

		img.src = imageUrl;

		img.onload = () => {
			img.classList.remove("hidden");
		};

		img.onerror = () => {
			fallback.classList.remove("hidden");
		};
	}

	function closeCheckInModal() {
		const modal = document.getElementById("checkInImageModal");
		const img = document.getElementById("checkInPreviewImage");

		modal.classList.add("hidden");
		modal.classList.remove("flex");
		img.src = "";
	}

	function openCheckOutModal(imageUrl) {
		const modal = document.getElementById("checkOutImageModal");
		const img = document.getElementById("checkOutPreviewImage");
		const fallback = document.getElementById("checkOutNoImage");

		modal.classList.remove("hidden");
		modal.classList.add("flex");

		img.classList.add("hidden");
		fallback.classList.add("hidden");

		img.src = imageUrl;

		img.onload = () => {
			img.classList.remove("hidden");
		};

		img.onerror = () => {
			fallback.classList.remove("hidden");
		};
	}

	function closeCheckOutModal() {
		const modal = document.getElementById("checkOutImageModal");
		const img = document.getElementById("checkOutPreviewImage");

		modal.classList.add("hidden");
		modal.classList.remove("flex");
		img.src = "";
	}
</script>