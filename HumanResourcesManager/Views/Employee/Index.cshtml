@using HumanResourcesManager.BLL.DTOs.Employee
@model TodayAttendanceViewDTO

@{
	Layout = "~/Views/Employee/_EmployeeLayout.cshtml";
}

<!-- Main Content -->
<main class="flex-1 overflow-y-auto bg-slate-50/50">
	@await Html.PartialAsync("_EmployeeHeader")

	<div class="p-5 lg:p-8">
		@await Html.PartialAsync("_EmployeeStats")

		<!-- Tabs Content -->
		<div class="bg-white rounded-2xl shadow-sm border border-slate-200/60 overflow-hidden">
			<!-- Attendance Tab -->
			<div id="attendanceTab" class="tab-content">
				<div class="px-6 py-6 border-b border-slate-200 bg-gradient-to-r from-slate-50 to-white">
					<div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4">

						<!-- Title + Subtitle -->
						<div>
							<h2 class="text-xl font-bold text-slate-800 tracking-tight">
								Chấm Công Hôm Nay
							</h2>
							<p class="text-sm text-slate-500 mt-1">
								Thực hiện check-in và check-out trong khung giờ làm việc của bạn.
							</p>
						</div>

						<!-- History Button -->
						<a asp-controller="Employee"
						   asp-action="History"
						   class="inline-flex items-center gap-2 bg-gradient-to-r
                  from-indigo-600 to-violet-600
                  hover:from-indigo-700 hover:to-violet-700
                  text-white px-5 py-2.5 rounded-xl text-sm font-semibold
                  shadow-md hover:shadow-lg transition-all duration-200">

							<svg xmlns="http://www.w3.org/2000/svg"
								 class="w-4 h-4"
								 fill="none"
								 viewBox="0 0 24 24"
								 stroke="currentColor"
								 stroke-width="2">
								<path stroke-linecap="round"
									  stroke-linejoin="round"
									  d="M9 17v-6h6v6m-6 0h6m-6 0H7m8 0h2m-6-6h6" />
							</svg>

							Xem Lịch Sử
						</a>

					</div>
				</div>

				<div class="p-6">
					<!-- Check In/Out Section -->
					<div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
						<!-- Check In Section -->
						<div class="bg-gradient-to-br from-blue-50 to-indigo-50/80 rounded-2xl p-6 border border-blue-100">
							<h3 class="text-base font-semibold text-slate-800 mb-4">📸 Check-in</h3>

							<form id="checkInForm"
								  method="post"
								  enctype="multipart/form-data"
								  action="/HumanResourcesManager/employee/attendance/check-in">

								@Html.AntiForgeryToken()

								<!-- Hidden fields -->
								<input type="hidden" name="WorkDate" id="checkInWorkDate" />
								<input type="hidden" name="CheckInTime" id="checkInTime" />
								<input type="file" name="CheckInImage" id="checkInFileInput" hidden />

								<div id="checkInArea">
									<video id="checkInVideo" class="w-full rounded-lg mb-4 hidden" autoplay></video>
									<canvas id="checkInCanvas" class="hidden"></canvas>

									<div id="checkInPhotoPreview" class="hidden mb-4">
										<img id="checkInPhotoImg" class="w-full rounded-lg">
									</div>

									<button type="button"
											id="startCheckInCameraBtn"
											class="w-full bg-blue-600 hover:bg-blue-700 text-white font-medium py-3 rounded-xl transition-colors mb-2 shadow-sm">
										📷 Bật Camera
									</button>

									<button type="button"
											id="captureCheckInBtn"
											class="w-full bg-emerald-600 hover:bg-emerald-700 text-white font-medium py-3 rounded-xl transition-colors hidden">
										✓ Chụp Ảnh
									</button>

									<button type="button"
											id="submitCheckInBtn"
											onclick="submitCheckInClick()"
											class="w-full bg-violet-600 hover:bg-violet-700 text-white font-medium py-3 rounded-xl transition-colors hidden">
										✓ Xác Nhận Check In
									</button>
								</div>

								<div id="checkInStatusWrapper" class="mt-4">
									<div id="checkInBadge"
										 class="inline-block px-3 py-1 rounded-full text-sm font-medium bg-gray-200 text-gray-700">
										--
									</div>

									<div id="checkInCountdown"
										 class="text-lg font-bold mt-2 text-slate-700 hidden">
										00:00:00
									</div>

									<div class="w-full bg-gray-200 rounded-full h-2 mt-2 overflow-hidden hidden"
										 id="checkInProgressWrapper">
										<div id="checkInProgress"
											 class="h-2 bg-blue-500 transition-all duration-1000 ease-linear"
											 style="width:0%">
										</div>
									</div>
								</div>

							</form>
						</div>

						<!-- Check Out Section -->
						<div class="bg-gradient-to-br from-amber-50 to-orange-50/80 rounded-2xl p-6 border border-amber-100">
							<h3 class="text-base font-semibold text-slate-800 mb-4">📸 Check-out</h3>

							<form id="checkOutForm"
								  method="post"
								  enctype="multipart/form-data"
								  action="/HumanResourcesManager/employee/attendance/check-out">

								@Html.AntiForgeryToken()

								<!-- Hidden fields -->
								<input type="hidden" name="WorkDate" id="checkOutWorkDate" />
								<input type="hidden" name="CheckOutTime" id="checkOutTime" />
								<input type="file" name="CheckOutImage" id="checkOutFileInput" hidden />

								<div id="checkOutArea">
									<video id="checkOutVideo" class="w-full rounded-lg mb-4 hidden" autoplay></video>
									<canvas id="checkOutCanvas" class="hidden"></canvas>

									<div id="checkOutPhotoPreview" class="hidden mb-4">
										<img id="checkOutPhotoImg" class="w-full rounded-lg">
									</div>

									<button type="button"
											id="startCheckOutCameraBtn"
											class="w-full bg-amber-600 hover:bg-amber-700 text-white font-medium py-3 rounded-xl transition-colors mb-2 shadow-sm">
										📷 Bật Camera
									</button>

									<button type="button"
											id="captureCheckOutBtn"
											class="w-full bg-emerald-600 hover:bg-emerald-700 text-white font-medium py-3 rounded-xl transition-colors hidden">
										✓ Chụp Ảnh
									</button>

									<button type="button"
											id="submitCheckOutBtn"
											onclick="submitCheckOutClick()"
											class="w-full bg-violet-600 hover:bg-violet-700 text-white font-medium py-3 rounded-xl transition-colors hidden">
										✓ Xác Nhận Check Out
									</button>
								</div>

								<div id="checkOutStatusWrapper" class="mt-4">

									<div id="checkOutBadge"
										 class="inline-block px-3 py-1 rounded-full text-sm font-medium bg-gray-200 text-gray-700">
										--
									</div>

									<div id="checkOutCountdown"
										 class="text-lg font-bold mt-2 text-slate-700 hidden">
										00:00:00
									</div>

									<div class="w-full bg-gray-200 rounded-full h-2 mt-2 overflow-hidden hidden"
										 id="checkOutProgressWrapper">

										<div id="checkOutProgress"
											 class="h-2 bg-amber-500 transition-all duration-1000 ease-linear"
											 style="width:0%">
										</div>

									</div>

								</div>
							</form>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
</main>

@section Scripts {
	<!-- Thông báo chấm công -->
	@if (TempData["Success"] != null)
	{
		<script>
			Swal.fire({
				toast: true,
				position: 'top-end',
				icon: 'success',
				title: @Html.Raw(Json.Serialize(TempData["Success"])),
				showConfirmButton: false,
				timer: 2500,
				timerProgressBar: true
			});
		</script>
	}

	@if (TempData["Error"] != null)
	{
		<script>
			Swal.fire({
				toast: true,
				position: 'top-end',
				icon: 'error',
				title: @Html.Raw(Json.Serialize(TempData["Error"])),
				showConfirmButton: false,
				timer: 3500,
				timerProgressBar: true
			});
		</script>
	}

	<script>
		window.attendanceState = {
			hasCheckIn: @(Model.CheckInTime != null ? "true" : "false"),
			hasCheckOut: @(Model.CheckOutTime != null ? "true" : "false"),
			isLeave: @(Model.IsLeave ? "true" : "false"),
			checkInTime: '@(Model.CheckInTime?.ToString(@"hh\:mm\:ss"))',
			checkOutTime: '@(Model.CheckOutTime?.ToString(@"hh\:mm\:ss"))'
		};
	</script>
}