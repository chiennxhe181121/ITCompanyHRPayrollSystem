@model HumanResourcesManager.BLL.DTOs.EmployeeAttendanceViewDTO

@{
	Layout = "~/Views/Employee/_EmployeeLayout.cshtml";
}

<!-- Main Content -->
<main class="flex-1 overflow-y-auto bg-slate-50/50">
	@await Html.PartialAsync("_EmployeeHeader")

	<div class="p-5 lg:p-8">
		@await Html.PartialAsync("_EmployeeStats")

		<!-- Tabs Content -->
		<div class="bg-white rounded-2xl shadow-sm border border-slate-200/60 overflow-hidden">
			<!-- Attendance Tab -->
			<div id="attendanceTab" class="tab-content">
				<div class="px-6 py-5 border-b border-slate-100 bg-slate-50/50">
					<h2 class="text-lg font-semibold text-slate-800">Chấm Công</h2>
				</div>
				<div class="p-6">
					<!-- Check In/Out Section -->
					<div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
						<div class="bg-gradient-to-br from-blue-50 to-indigo-50/80 rounded-2xl p-6 border border-blue-100">
							<h3 class="text-base font-semibold text-slate-800 mb-4">📸 Chấm Công Vào</h3>
							<div id="checkInArea">
								<video id="checkInVideo" class="w-full rounded-lg mb-4 hidden" autoplay></video>
								<canvas id="checkInCanvas" class="hidden"></canvas>
								<div id="checkInPhotoPreview" class="hidden mb-4">
									<img id="checkInPhotoImg" class="w-full rounded-lg">
								</div>
								<button id="startCheckInCameraBtn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-medium py-3 rounded-xl transition-colors mb-2 shadow-sm">
									📷 Bật Camera
								</button>
								<button id="captureCheckInBtn" class="w-full bg-emerald-600 hover:bg-emerald-700 text-white font-medium py-3 rounded-xl transition-colors hidden">
									✓ Chụp Ảnh
								</button>
								<button id="submitCheckInBtn" class="w-full bg-violet-600 hover:bg-violet-700 text-white font-medium py-3 rounded-xl transition-colors hidden">
									✓ Xác Nhận Check In
								</button>
							</div>
							<p class="text-sm text-slate-600 mt-3" id="checkInStatus">Chưa check-in hôm nay</p>
						</div>

						<div class="bg-gradient-to-br from-amber-50 to-orange-50/80 rounded-2xl p-6 border border-amber-100">
							<h3 class="text-base font-semibold text-slate-800 mb-4">📸 Chấm Công Ra</h3>
							<div id="checkOutArea">
								<video id="checkOutVideo" class="w-full rounded-lg mb-4 hidden" autoplay></video>
								<canvas id="checkOutCanvas" class="hidden"></canvas>
								<div id="checkOutPhotoPreview" class="hidden mb-4">
									<img id="checkOutPhotoImg" class="w-full rounded-lg">
								</div>
								<button id="startCheckOutCameraBtn" class="w-full bg-amber-600 hover:bg-amber-700 text-white font-medium py-3 rounded-xl transition-colors mb-2 shadow-sm">
									📷 Bật Camera
								</button>
								<button id="captureCheckOutBtn" class="w-full bg-emerald-600 hover:bg-emerald-700 text-white font-medium py-3 rounded-xl transition-colors hidden">
									✓ Chụp Ảnh
								</button>
								<button id="submitCheckOutBtn" class="w-full bg-violet-600 hover:bg-violet-700 text-white font-medium py-3 rounded-xl transition-colors hidden">
									✓ Xác Nhận Check Out
								</button>
							</div>
							<p class="text-sm text-slate-600 mt-3" id="checkOutStatus">Chưa check-out hôm nay</p>
						</div>
					</div>

					<!-- Attendance History -->
					<div>
						<h3 class="text-base font-semibold text-slate-800 mb-3">Lịch Sử Chấm Công</h3>
						<div class="overflow-x-auto rounded-xl border border-slate-200/80">
							<table class="min-w-full text-sm text-slate-700 border-collapse">
								<thead>
									<tr class="bg-slate-100 border-b border-slate-200">
										<th class="py-3 px-4 text-center font-semibold uppercase tracking-wide text-xs">STT</th>
										<th class="py-3 px-4 text-center font-semibold uppercase tracking-wide text-xs">Ngày</th>
										<th class="py-3 px-4 text-center font-semibold uppercase tracking-wide text-xs">Giờ vào</th>
										<th class="py-3 px-4 text-center font-semibold uppercase tracking-wide text-xs">Ảnh</th>
										<th class="py-3 px-4 text-center font-semibold uppercase tracking-wide text-xs">Giờ ra</th>
										<th class="py-3 px-4 text-center font-semibold uppercase tracking-wide text-xs">Ảnh</th>
										<th class="py-3 px-4 text-center font-semibold uppercase tracking-wide text-xs">Thiếu (phút)</th>
										<th class="py-3 px-4 text-center font-semibold uppercase tracking-wide text-xs">Trạng thái</th>
									</tr>
								</thead>

								<tbody class="divide-y divide-slate-100">
									@{
										int pageSize = Model.PageSize; // ví dụ 10
										int startIndex = (Model.CurrentPage - 1) * pageSize;
										int index = 0;
									}

									@foreach (var item in Model.Records)
									{
										<!-- STT -->
										index++;
										<tr class="hover:bg-slate-50 transition-colors duration-150">

											<!-- STT -->
											<td class="py-3 px-4 text-center text-slate-500 font-medium">
												@(startIndex + index)
											</td>

											<!-- Work Date -->
											<td class="py-3 px-4 text-center font-medium text-slate-800">
												@item.WorkDate.ToString("dd/MM/yyyy")
											</td>

											<!-- Check In -->
											<td class="py-3 px-4 text-center">
												@(item.CheckIn?.ToString(@"hh\:mm") ?? "---")
											</td>

											<!-- Check In Image -->
											<td class="py-3 px-4 text-center">
												@if (!string.IsNullOrEmpty(item.CheckInImagePath))
												{
													<a href="@Url.Content(item.CheckInImagePath)" target="_blank"
													   class="inline-flex items-center justify-center text-indigo-600 hover:text-indigo-800 transition">
														<svg xmlns="http://www.w3.org/2000/svg"
															 class="h-5 w-5"
															 fill="none"
															 viewBox="0 0 24 24"
															 stroke="currentColor"
															 stroke-width="1.8">
															<path stroke-linecap="round" stroke-linejoin="round"
																  d="M2.25 12s3.75-7.5 9.75-7.5S21.75 12 21.75 12
		                                         18 19.5 12 19.5 2.25 12 2.25 12z" />
															<circle cx="12" cy="12" r="3" />
														</svg>
													</a>
												}
												else
												{
													<span class="text-slate-300">—</span>
												}
											</td>

											<!-- Check Out -->
											<td class="py-3 px-4 text-center">
												@(item.CheckOut?.ToString(@"hh\:mm") ?? "---")
											</td>

											<!-- Check Out Image -->
											<td class="py-3 px-4 text-center">
												@if (!string.IsNullOrEmpty(item.CheckOutImagePath))
												{
													<a href="@Url.Content(item.CheckOutImagePath)" target="_blank"
													   class="inline-flex items-center justify-center text-indigo-600 hover:text-indigo-800 transition">
														<svg xmlns="http://www.w3.org/2000/svg"
															 class="h-5 w-5"
															 fill="none"
															 viewBox="0 0 24 24"
															 stroke="currentColor"
															 stroke-width="1.8">
															<path stroke-linecap="round" stroke-linejoin="round"
																  d="M2.25 12s3.75-7.5 9.75-7.5S21.75 12 21.75 12
		                                         18 19.5 12 19.5 2.25 12 2.25 12z" />
															<circle cx="12" cy="12" r="3" />
														</svg>
													</a>
												}
												else
												{
													<span class="text-slate-300">—</span>
												}
											</td>

											<!-- Missing Minutes -->
											<td class="py-3 px-4 text-center">
												@if (item.MissingMinutes > 0)
												{
													<span class="px-2 py-1 rounded-md text-xs bg-orange-100 text-orange-700 font-medium">
														@item.MissingMinutes
													</span>
												}
												else
												{
													<span class="text-slate-400">0</span>
												}
										</td>

										<!-- Status -->
										<td class="py-3 px-4 text-center">
											<span class="px-3 py-1 text-xs font-medium rounded-full
                        @(item.Status switch
				 {
					 "Đủ công" => "bg-green-100 text-green-700",
					 "Thiếu công" => "bg-orange-100 text-orange-700",
					 "Đang làm việc" => "bg-indigo-100 text-indigo-700",
					 "Nghỉ có phép" => "bg-blue-100 text-blue-700",
					 "Thiếu Check-in" => "bg-yellow-100 text-yellow-700",
					 "Thiếu Check-out" => "bg-yellow-100 text-yellow-700",
					 "Nghỉ không phép" => "bg-red-100 text-red-700",
					 _ => "bg-gray-100 text-gray-600"
				 })">
												@item.Status
											</span>
										</td>

									</tr>
																		}
								</tbody>
							</table>
						</div>


						<!-- Phân Trang -->
						@{
							int currentPage = Model.CurrentPage;
							int totalPages = Model.TotalPages;

							int pageWindow = 1; // số trang hiển thị trước và sau currentPage
							int startPage = Math.Max(1, currentPage - pageWindow);
							int endPage = Math.Min(totalPages, currentPage + pageWindow);
						}

						@if (totalPages > 1)
						{
							<div class="flex justify-center mt-6 space-x-1 items-center">

								<!-- Prev -->
								<a href="@(currentPage > 1 ? $"?page={currentPage - 1}" : "#")"
								   class="px-3 py-1 border rounded-lg transition
	           @(currentPage > 1
				   		  ? "bg-white hover:bg-slate-100"
				   		  : "bg-slate-100 text-slate-400 cursor-not-allowed pointer-events-none")">
								&lt;
							</a>

								<!-- First page -->
							@if (startPage > 1)
								{
									<a href="?page=1"
									   class="px-3 py-1 border rounded-lg bg-white hover:bg-slate-100">
										1
									</a>

									@if (startPage > 2)
									{
										<span class="px-2 text-slate-400">...</span>
									}
								}

								<!-- Middle pages -->
								@for (int i = startPage; i <= endPage; i++)
								{
									<a href="?page=@i"
									   class="px-3 py-1 border rounded-lg transition
		               @(i == currentPage
						   		  ? "bg-indigo-600 text-white"
						   		  : "bg-white hover:bg-slate-100")">
								@i
							</a>
														}

								<!-- Last page -->
								@if (endPage < totalPages)
								{
									@if (endPage < totalPages - 1)
									{
										<span class="px-2 text-slate-400">...</span>
									}

									<a href="?page=@totalPages"
									   class="px-3 py-1 border rounded-lg bg-white hover:bg-slate-100">
										@totalPages
									</a>
								}

							<!-- Next -->
							<a href="@(currentPage < totalPages ? $"?page={currentPage + 1}" : "#")"
							   class="px-3 py-1 border rounded-lg transition
           @(currentPage < totalPages
			   		  ? "bg-white hover:bg-slate-100"
			   		  : "bg-slate-100 text-slate-400 cursor-not-allowed pointer-events-none")">
								&gt;
							</a>

							</div>
												}
					</div>
				</div>
			</div>
		</div>
	</div>
</main>